# 城市动保协同平台前端需求开发文档（Vue2 Web）

- 文档版本：v0.1
- 编写日期：2026-02-05
- 对齐文档：`docs/需求规格说明书.md`、`docs/数据库设计说明书.md`
- 端与角色：公众用户（PUBLIC）、执法部门（LAW）、救助医疗机构（RESCUE）、系统管理员（ADMIN）

## 1. 目标与范围

### 1.1 目标

- 以“事件上报—执法处理—救助医疗—统计监管”闭环为主线，提供四端 Web 使用界面与一致的交互体验。
- 在同一前端工程内通过角色路由与权限控制实现多端可复用（也支持后续拆分成多工程）。

### 1.2 范围（本期必须）

- 四端页面与交互：严格对应需求文档 5.2~5.5 功能清单。
- 通用支撑：登录、地图选点/定位、附件上传、消息反馈、基础查询筛选、操作留痕（前端需传递操作者信息）。

## 2. 技术与工程约定（建议）

> 若你已有统一技术选型，可替换本节。

- 框架：Vue2 + Vue Router + Vuex
- UI：Element UI（PC 优先），移动端适配采用响应式布局（不强制引入 Vant）
- HTTP：Axios（统一拦截器处理 Token、错误码、重试与提示）
- 图表：ECharts（管理员大屏与统计）
- 地图：高德/腾讯/百度其一（需支持选点、逆地理、轨迹绘制；具体 SDK 由实现确定）
- 富文本：用于课堂图文内容（可选）

## 3. 信息架构与路由

### 3.1 应用结构

- 单应用多角色：登录后根据 `role_code`（PUBLIC/LAW/RESCUE/ADMIN）下发可访问菜单与路由。
- 统一布局：`Header + SideMenu(PC) + Main`；公众端可采用顶部 Tab/底部导航（响应式）。

### 3.2 路由表（建议）

| 角色 | 一级模块 | 路由示例 | 说明 |
|---|---|---|---|
| 通用 | 登录/注册 | `/login` | 手机验证码登录（后端实现） |
| 通用 | 消息中心 | `/messages` | 处理进度/反馈推送 |
| PUBLIC | 事件 | `/public/events` | 事件列表/筛选 |
| PUBLIC | 事件详情 | `/public/events/:id` | 跟进、补充、评论、反馈 |
| PUBLIC | 任务大厅 | `/public/tasks` | 志愿者任务认领 |
| PUBLIC | 巡护上报 | `/public/patrol/submit/:claimId` | 轨迹+风险点 |
| PUBLIC | 领养 | `/public/adoption` | 动物列表、申请、我的申请 |
| PUBLIC | 回访 | `/public/followups` | 回访列表、提交材料 |
| PUBLIC | 捐赠 | `/public/donations` | 事件/机构定向捐赠、记录 |
| PUBLIC | 动保课堂 | `/public/classroom` | 图文/视频列表与详情 |
| LAW | 工单 | `/law/workorders` | 工单列表、筛选、受理 |
| LAW | 工单详情 | `/law/workorders/:id` | 分派、取证、结果录入、公示、归档 |
| RESCUE | 任务 | `/rescue/tasks` | 接收/评估、调度、进度 |
| RESCUE | 动物档案 | `/rescue/animals` | 建档、查看 |
| RESCUE | 病历 | `/rescue/animals/:id/records` | 治疗记录维护 |
| RESCUE | 库存 | `/rescue/inventory` | 物资药品、预警 |
| ADMIN | 大屏 | `/admin/dashboard` | 全域事件动态 |
| ADMIN | 报表 | `/admin/reports` | 多维统计图表 |
| ADMIN | 权限配置 | `/admin/acl` | 角色权限点配置 |
| ADMIN | 审核管理 | `/admin/approvals` | 流程定义与维护 |

## 4. 通用交互规范

### 4.1 登录与会话

- 登录成功后保存 `access_token`（建议 JWT）与 `user_profile`（含 `role_code/org_id`）。
- 全局路由守卫：
  - 未登录访问受限路由 → 跳转登录
  - 已登录但角色不匹配/无权限 → 展示 403 页面
- Token 过期：
  - 接口返回统一错误码（如 401）→ 清理会话 → 跳转登录并提示

### 4.2 地图与定位

- 事件上报/任务创建/风险点标注使用统一组件 `MapPicker`：
  - 自动定位（允许用户拒绝）
  - 选点返回：`latitude/longitude/address/region_code`
- 轨迹回放：
  - 轨迹点数量大时按时间抽稀绘制（前端优化）

### 4.3 附件上传

- 统一组件 `Uploader`：
  - 图片：最多 9 张（可配置）；视频：最多 1 个（可配置）
  - 上传前校验：类型/大小
  - 上传后返回 `file_url`，提交业务时携带 `biz_type/biz_id`

### 4.4 列表、筛选与分页

- 列表默认分页：`pageNo/pageSize`；支持关键词与状态筛选。
- 列表字段脱敏展示由后端返回决定，前端不自行推断敏感字段。

## 5. 四端页面需求（严格对应功能清单）

> 每个页面需提供：加载态、空态、异常态（网络/权限/不存在）。

### 5.1 公众用户端（PUBLIC）

#### 5.1.1 事件上报（FR-PUB-01）

- 入口：`/public/events/new`（可放在事件列表“上报”按钮）
- 表单字段：
  - 事件类型 `event_type`（下拉）
  - 紧急程度 `urgency`（单选）
  - 描述 `description`（必填，最少 10 字）
  - 位置（MapPicker：lat/lng/address/region_code，必填）
  - 附件（图片/视频）
- 提交成功：
  - 跳转事件详情页，展示“已上报”时间线节点
  - 写入消息中心一条“上报成功”回执

#### 5.1.2 事件跟进（FR-PUB-02）

- 事件详情页展示：
  - 基本信息：类型、紧急程度、位置（可脱敏）、上报时间
  - 状态：`status` + 进度条/标签
  - 时间线：来自 `ap_event_timeline`
  - 反馈：来自 `ap_message`（ref 指向 event）

#### 5.1.3 线索补充（FR-PUB-03）

- 事件详情页提供“补充信息”入口：
  - 追加描述与附件
  - 提交后在时间线增加“补充”节点

#### 5.1.4 互动评论（FR-PUB-04）

- 事件详情页评论区：
  - 发表评论/回复
  - 展示时间、作者昵称（匿名上报不影响评论展示规则，由后端控制）

#### 5.1.5 任务认领（FR-PUB-05）

- 任务大厅（列表）：
  - 筛选：任务类型、区域、时间、距离（可选）
  - 卡片：标题、地点、时间窗、剩余名额、状态
- 任务详情：
  - “认领”按钮：提交 `task_id` 创建 `ap_task_claim`
  - 已认领状态：展示开始/完成/取消入口

#### 5.1.6 巡护上报（FR-PUB-06）

- 前置条件：存在 `task_claim` 且状态 `STARTED/FINISHED`
- 上报内容：
  - 轨迹采集：启动后周期采集点（如 3~5s/次；可配置）
  - 风险点：点击地图标注风险类型+描述+附件
  - 提交：生成 `ap_patrol_report`，批量上传 `ap_patrol_track_point`，风险点写入 `ap_risk_point`

#### 5.1.7 动物领养（FR-PUB-07）

- 动物列表：
  - 展示：物种、照片、健康摘要、领养状态
  - 筛选：物种、状态（READY_FOR_ADOPTION 等）
- 申请表单（结构化 JSON）：
  - 基础信息、居住条件、经验、承诺条款勾选

#### 5.1.8 回访管理（FR-PUB-08）

- 回访列表：
  - 展示：动物、回访期次（可由后端标记）、提交状态
- 回访提交：
  - 问卷（JSON 表单）+ 附件（ap_attachment）

#### 5.1.9 公益捐助（FR-PUB-09）

- 捐赠入口：
  - 按事件：从事件详情“捐赠”进入（target=EVENT）
  - 按机构：机构列表/详情“捐赠”（target=ORG）
- 表单：
  - 金额、匿名开关
  - 提交后展示捐赠记录（状态由后端返回）

#### 5.1.10 动保课堂（FR-PUB-10）

- 列表：
  - 分类、搜索、分页
- 详情：
  - 图文渲染/视频播放

### 5.2 执法部门端（LAW）

#### 5.2.1 工单受理（FR-LAW-01）

- 工单列表：
  - 筛选：状态、事件类型、区域、时间
- 工单详情：
  - 展示关联事件信息与时间线
  - 受理判断：
    - `need_law_enforcement`（是/否）
    - 若否：填写处理结论（写时间线+结果记录），并可继续判断是否转送救助

#### 5.2.2 任务分派（FR-LAW-02）

- 工单详情提供“派发”能力：
  - 选择处理人（同组织用户列表）
  - 更新工单状态与时间线节点

#### 5.2.3 现场取证（FR-LAW-03）

- 取证记录表单：
  - 位置、文字说明、附件上传（图片/视频）
  - 保存为 `ap_law_evidence`，附件 `biz_type=LAW_EVIDENCE`

#### 5.2.4 结果录入（FR-LAW-04）

- 结果录入：
  - 内部结果文本 + 公示文本
  - 点击“公示”设置 `published_at` 并写事件时间线“公示”节点

#### 5.2.5 案件归档（FR-LAW-05）

- 归档页签：
  - 填写归档摘要、归档编号（可自动生成）
  - 上传归档包/材料（附件 `biz_type=CASE_ARCHIVE`）

### 5.3 救助医疗机构端（RESCUE）

#### 5.3.1 任务接收（FR-RES-01）

- 任务列表：
  - 来源：转送或抢单；展示事件信息摘要
- 评估是否救助：
  - `need_rescue`（是/否）
  - 若否：填写结论并推送反馈（事件时间线“反馈/结论”节点）

#### 5.3.2 救助调度（FR-RES-02）

- 调度面板：
  - 记录调度说明与关键时间（出发/到达/入站等）
  - 每次节点变更写事件时间线“救助进度”

#### 5.3.3 动物建档（FR-RES-03）

- 入站建档表单：
  - 物种、性别、年龄估计、体检摘要、照片（附件 `biz_type=ANIMAL` 或 `EVENT`）
  - 生成 `ap_animal`

#### 5.3.4 治疗记录（FR-RES-04）

- 病历维护：
  - 记录类型（检查/治疗/用药/康复）+ 结构化表单（JSON）
  - 附件 `biz_type=MEDICAL_RECORD`

#### 5.3.5 病历共享（FR-RES-05）

> 本期数据库仅预留审核/权限能力，病历共享页面可先做“共享开关/授权对象选择”的交互原型，后端落地时对齐权限点与审核流程。

#### 5.3.6 库存管理（FR-RES-06）

- 品项管理：
  - 物资/药品品项、阈值维护
- 批次与库存：
  - 批次（有效期、当前数量）
  - 出入库流水登记（IN/OUT/ADJUST）
- 预警展示：
  - 低库存、临期（由后端聚合返回）

### 5.4 系统管理员端（ADMIN）

#### 5.4.1 数据监控（FR-ADM-01）

- 大屏模块：
  - 地图态势（热力/聚类/点位）
  - 指标卡片：新增、处理中、已闭环
  - 趋势图：按日/周/月

#### 5.4.2 统计报表（FR-ADM-02）

- 报表页面：
  - 多维筛选：时间、区域、类型、组织
  - 图表：柱状/折线/饼图
  - 导出（若后端支持）：下载链接方式

#### 5.4.3 权限配置（FR-ADM-03）

- 角色管理：
  - 四端角色展示（可扩展权限点）
  - 权限点勾选与保存（`ap_permission/ap_role_permission`）

#### 5.4.4 审核管理（FR-ADM-04）

- 流程定义：
  - 业务类型 `biz_type`（如 ADOPTION、MEDICAL_SHARE 等）
  - 多级节点配置（JSON 表单编辑器）：节点序号、审批角色、超时规则、通过/驳回分支

## 6. 前端数据模型（与数据库表对齐）

### 6.1 核心 DTO（示例字段）

- EventDTO（`ap_event`）：`id/event_type/urgency/description/status/address/latitude/longitude/reported_at`
- TimelineDTO（`ap_event_timeline`）：`id/event_id/node_type/content/operator_role/created_at`
- WorkOrderDTO（`ap_work_order`）：`id/event_id/law_org_id/status/need_law_enforcement/transfer_to_rescue/assignee_user_id`
- RescueTaskDTO（`ap_rescue_task`）：`id/event_id/rescue_org_id/status/need_rescue/dispatch_at/arrived_at/intake_at`
- AnimalDTO（`ap_animal`）：`id/rescue_task_id/species/health_summary/status`
- MedicalRecordDTO（`ap_medical_record`）：`id/animal_id/record_type/record_content/recorded_at`
- TaskDTO（`ap_task`）：`id/task_type/title/region_code/status/start_at/end_at`
- PatrolReportDTO（`ap_patrol_report`）：`id/claim_id/summary/distance_km/duration_sec/submitted_at`

### 6.2 枚举（前端常量）

- RoleCode：`PUBLIC/LAW/RESCUE/ADMIN`
- EventStatus：以接口返回为准（用于标签映射）
- TaskType：`PATROL/RESCUE_SUPPORT`
- WorkOrderStatus/RescueTaskStatus：以接口返回为准

## 7. API 清单（前端视角）

> 仅定义“前端需要哪些接口”。路径与字段可在后端设计时最终确定。

### 7.1 通用

- `POST /api/auth/sms/send` 发送验证码
- `POST /api/auth/login` 登录（返回 token + profile）
- `GET /api/me` 当前用户信息
- `GET /api/messages` 消息列表
- `POST /api/upload` 上传附件（返回 `file_url/sha256`）

### 7.2 公众端

- `POST /api/events` 上报事件
- `GET /api/events` 事件列表（本人/公开）
- `GET /api/events/{id}` 事件详情
- `POST /api/events/{id}/supplements` 线索补充（写时间线）
- `GET /api/events/{id}/timeline` 时间线
- `GET /api/events/{id}/comments` 评论列表
- `POST /api/events/{id}/comments` 发表评论/回复
- `GET /api/tasks` 任务大厅
- `POST /api/tasks/{id}/claim` 任务认领
- `POST /api/task-claims/{id}/start` 开始任务
- `POST /api/patrol-reports` 提交巡护上报（含轨迹点/风险点）
- `GET /api/animals` 可领养动物列表
- `POST /api/adoptions` 提交领养申请
- `GET /api/followups` 回访列表
- `POST /api/followups` 提交回访
- `POST /api/donations` 发起捐赠/登记
- `GET /api/content` 课堂列表
- `GET /api/content/{id}` 课堂详情

### 7.3 执法端

- `GET /api/law/workorders` 工单列表
- `GET /api/law/workorders/{id}` 工单详情
- `POST /api/law/workorders/{id}/accept` 受理判断（是否需执法、结论）
- `POST /api/law/workorders/{id}/assign` 任务分派
- `POST /api/law/evidence` 新增取证记录（附件另走上传）
- `POST /api/law/workorders/{id}/result` 结果录入与公示
- `POST /api/law/workorders/{id}/archive` 案件归档
- `POST /api/law/workorders/{id}/transfer-to-rescue` 转送救助（创建/通知救助任务）

### 7.4 救助端

- `GET /api/rescue/tasks` 任务列表
- `POST /api/rescue/tasks/{id}/evaluate` 评估是否救助
- `POST /api/rescue/tasks/{id}/dispatch` 救助调度节点更新
- `POST /api/rescue/animals` 动物建档
- `GET /api/rescue/animals` 动物列表
- `POST /api/rescue/medical-records` 新增/更新治疗记录
- `GET /api/rescue/inventory/items` 库存品项
- `POST /api/rescue/inventory/txns` 出入库流水

### 7.5 管理员端

- `GET /api/admin/dashboard/metrics` 大屏指标
- `GET /api/admin/dashboard/map` 地图态势数据
- `GET /api/admin/reports` 报表数据
- `GET /api/admin/permissions` 权限点列表
- `POST /api/admin/role-permissions` 保存角色权限
- `GET /api/admin/approval-flows` 流程列表
- `POST /api/admin/approval-flows` 新增/更新流程定义

## 8. 权限与菜单控制（前端落地）

- 菜单由后端下发（推荐），前端按 `perm_code` 渲染。
- 路由守卫基于：
  - `role_code`（端隔离）
  - `perm_codes`（细粒度按钮/页面权限）
- 操作按钮需统一使用指令/组件封装：`v-perm="'LAW.WORK_ORDER.ASSIGN'"`（示例）。

## 9. 非功能与体验要求

- 关键操作二次确认：删除、取消任务、发布公示（如需要）
- 表单防抖与重复提交保护
- 大文件上传显示进度条
- 大屏页面支持全屏与自动刷新（可配置 30s/60s）

## 10. 交付物清单（前端）

- 路由与菜单结构
- 四端页面原型（建议后续补充 Axure/Figma）
- 组件库：MapPicker、Uploader、Timeline、StatusTag、ChartPanel
- API 封装与错误码规范

