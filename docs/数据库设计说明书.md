# 城市动保协同平台数据库设计说明书（MySQL 5.7）

- 文档版本：v0.1
- 编写日期：2026-02-05
- 适用范围：与 `docs/需求规格说明书.md` 配套（四端：公众用户、执法部门、救助医疗机构、系统管理员）

## 1. 设计目标

- 支撑“事件上报—执法处理—救助医疗—统计监管”的闭环流程与可追溯时间线。
- 支撑四类角色的数据隔离：公众用户、执法部门、救助医疗机构、系统管理员。
- 支撑附件（图片/视频/材料）统一存储引用、消息反馈、审计留痕、统计查询。

## 2. 数据库与约定

- 数据库：MySQL 5.7，存储引擎 InnoDB，字符集 `utf8mb4`，排序规则 `utf8mb4_unicode_ci`
- 主键：`BIGINT UNSIGNED` 自增
- 时间字段：`DATETIME(3)`；统一使用 `created_at/updated_at/deleted_at`
- 软删除：`deleted_at` 非空表示逻辑删除（业务查询默认过滤）
- 统一附件：`ap_attachment` 用 `biz_type + biz_id` 关联业务对象
- 统一消息：`ap_message` 记录“处理进度/反馈”类通知
- 约束策略：数据库结构不使用外键，依赖应用层保证引用完整性；通过索引与唯一约束保障查询与去重
- 权限配置：仅四端角色（PUBLIC/LAW/RESCUE/ADMIN），权限点可由管理员配置

## 3. 概念模型与表清单

### 3.1 账号与组织

- `ap_organization`：组织（执法部门/救助医疗机构/平台）
- `ap_user`：用户（四端角色；执法/机构/管理员绑定组织）
- `ap_role` / `ap_permission` / `ap_role_permission`：角色与权限点（用于“权限配置”）

### 3.2 事件闭环（核心链路）

- `ap_event`：事件（公众上报起点，含位置与状态）
- `ap_event_timeline`：事件时间线（上报/补充/执法/救助/反馈节点）
- `ap_attachment`：附件（事件/取证/病历/回访等统一引用）
- `ap_comment`：互动评论（事件下留言）
- `ap_message`：消息反馈（事件状态/反馈推送记录）
- `ap_task` / `ap_task_claim`：志愿者任务（巡护/救助协助）与认领记录
- `ap_patrol_report` / `ap_patrol_track_point`：巡护上报（执行结果、轨迹点）
- `ap_risk_point`：巡护风险点（与轨迹/事件形成数据支撑）

### 3.3 执法处置

- `ap_work_order`：执法工单（接收工单、是否需执法、是否转送救助）
- `ap_law_evidence`：现场取证记录（可挂附件）
- `ap_law_result`：结果录入与公示（可存公示文本与录入时间）
- `ap_case_archive`：案件归档（归档编号/归档时间/归档摘要/归档包附件）

### 3.4 救助医疗

- `ap_rescue_task`：救助任务（机构接收/评估是否救助/调度进度）
- `ap_animal`：动物档案（入站体检建档）
- `ap_medical_record`：治疗记录（诊疗/用药/康复信息；可挂附件）
- `ap_inventory_item` / `ap_inventory_batch` / `ap_inventory_txn`：库存管理（统计与预警）

### 3.5 领养与回访（公众端）

- `ap_adoption`：领养申请
- `ap_follow_up`：回访问卷与材料（可挂附件）

### 3.6 公益捐助与动保课堂（公众端）

- `ap_donation`：定向捐赠（按事件或机构）
- `ap_content_category` / `ap_content`：课堂内容（图文/视频）

### 3.7 审核与审计（管理员端）

- `ap_approval_flow`：审核流程定义（多级节点）
- `ap_approval_instance`：审核实例（绑定业务对象）
- `ap_audit_log`：审计日志（权限配置、流程维护、关键业务操作留痕）

## 4. 关键关系（摘要）

- 组织 `ap_organization` 1—N 用户 `ap_user`
- 事件 `ap_event` 1—N 时间线 `ap_event_timeline` / 评论 `ap_comment` / 附件 `ap_attachment`（通过 biz 关联）
- 事件 `ap_event` 1—N 执法工单 `ap_work_order`
- 工单 `ap_work_order` 1—N 取证 `ap_law_evidence`；1—1 结果 `ap_law_result`；0—1 归档 `ap_case_archive`
- 事件 `ap_event` 1—N 救助任务 `ap_rescue_task`
- 救助任务 `ap_rescue_task` 1—N 动物档案 `ap_animal`；动物 `ap_animal` 1—N 治疗记录 `ap_medical_record`
- 动物 `ap_animal` 0—N 领养 `ap_adoption`；领养 `ap_adoption` 1—N 回访 `ap_follow_up`
- 任务 `ap_task` 1—N 认领 `ap_task_claim`；认领 `ap_task_claim` 0—1 巡护上报 `ap_patrol_report`
- 巡护上报 `ap_patrol_report` 1—N 轨迹点 `ap_patrol_track_point`；1—N 风险点 `ap_risk_point`

## 5. 索引与查询要点（摘要）

- 事件列表：`(region_code, status, created_at)`；地理查询按业务可引入空间索引（后续扩展）
- 时间线：`(event_id, created_at)`
- 工单：`(law_org_id, status, created_at)`；救助任务：`(rescue_org_id, status, created_at)`
- 附件：`(biz_type, biz_id, created_at)`
- 捐赠：`(target_type, target_id, donated_at)`
- 巡护：轨迹点按 `report_id` 聚合；风险点按 `(risk_type, created_at)` 支撑趋势统计

## 6. 初始化 SQL

对应的建表与基础字典 SQL：`docs/数据库初始化_mysql.sql`

## 7. 表结构概要（关键字段）

> 完整字段以 `docs/数据库初始化_mysql.sql` 为准，本节用于快速对照需求与流程。

### 7.1 组织与账号

- `ap_organization`：`org_type`、`name`、`region_code`、`status`
- `ap_user`：`role_code`（PUBLIC/LAW/RESCUE/ADMIN）、`org_id`、`phone`、`is_volunteer`、`status`
- `ap_role`：四端角色字典；`ap_permission/ap_role_permission`：权限配置

### 7.2 事件闭环

- `ap_event`：`event_type`、`urgency`、`description`、`status`、`reporter_user_id`、位置（`region_code/lat/lng/address`）、`reported_at`
- `ap_event_timeline`：`event_id`、`node_type`、`content`、`operator_role/operator_user_id`、`created_at`
- `ap_attachment`：统一附件引用（`biz_type/biz_id/file_url/sha256`）
- `ap_comment`：事件评论（`event_id/parent_id/author_user_id/content/status`）
- `ap_message`：反馈推送记录（`user_id/msg_type/title/content/ref_type/ref_id/read_at`）

### 7.3 志愿者任务与巡护上报

- `ap_task`：任务大厅（`task_type/title/region_code/lat/lng/time_window/status/max_claims`）
- `ap_task_claim`：任务认领（`task_id/user_id/status/claimed_at/started_at/finished_at`）
- `ap_patrol_report`：巡护上报（`claim_id/summary/distance_km/duration_sec/submitted_at`）
- `ap_patrol_track_point`：轨迹点（`report_id/seq_no/lat/lng/point_time`）
- `ap_risk_point`：风险点（`report_id/risk_type/lat/lng/found_at`，附件走 `ap_attachment`）

### 7.4 执法处置

- `ap_work_order`：工单（`event_id/law_org_id/status/need_law_enforcement/transfer_to_rescue/assignee_user_id`）
- `ap_law_evidence`：取证记录（`work_order_id/note/lat/lng/collected_at`，附件走 `ap_attachment`）
- `ap_law_result`：结果录入与公示（`work_order_id/result_text/public_text/published_at`）
- `ap_case_archive`：案件归档（`work_order_id/archive_no/summary/archived_at`，归档包附件走 `ap_attachment`）

### 7.5 救助医疗

- `ap_rescue_task`：救助任务（`event_id/rescue_org_id/status/need_rescue/dispatch_at/arrived_at/intake_at/closed_at`）
- `ap_animal`：动物建档（`rescue_task_id/shelter_no/species/health_summary/status`）
- `ap_medical_record`：治疗记录（`animal_id/record_type/record_content(record JSON)/recorded_at`，附件走 `ap_attachment`）
- `ap_inventory_item`：库存品项（`org_id/item_name/spec/unit/low_stock_threshold`）
- `ap_inventory_batch`：批次（`item_id/batch_no/expiry_date/qty`）
- `ap_inventory_txn`：库存流水（`txn_type/qty/ref_type/ref_id/operator_user_id`）

### 7.6 领养、回访、捐赠、课堂

- `ap_adoption`：领养申请（`animal_id/applicant_user_id/status/apply_form(JSON)`）
- `ap_follow_up`：回访（`adoption_id/due_at/questionnaire(JSON)/submitted_at`，附件走 `ap_attachment`）
- `ap_donation`：捐赠（`target_type/target_id/amount/status/anonymous`）
- `ap_content_category/ap_content`：动保课堂（图文/视频、分类、发布状态）

### 7.7 审核与审计

- `ap_approval_flow`：审核流程（`biz_type/steps(JSON)`）
- `ap_approval_instance`：审核实例（`biz_type/biz_id/status/current_step`）
- `ap_audit_log`：审计日志（`actor_user_id/action/target_type/target_id/detail(JSON)`）
