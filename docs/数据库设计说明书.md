# 城市动保协同平台数据库设计说明书（MySQL 5.7）

- 文档版本：v0.1
- 编写日期：2026-02-05
- 适用范围：与 `docs/需求规格说明书.md` 配套（四端：公众用户、执法部门、救助医疗机构、系统管理员）

## 1. 设计目标

- 支撑“事件上报—执法处理—救助医疗—统计监管”的闭环流程与可追溯时间线。
- 支撑四类角色的数据隔离：公众用户、执法部门、救助医疗机构、系统管理员。
- 支撑附件（图片/视频/材料）统一存储引用、消息反馈、审计留痕、统计查询。

## 2. 数据库与约定

- 数据库：MySQL 5.7，存储引擎 InnoDB，字符集 `utf8mb4`，排序规则 `utf8mb4_unicode_ci`
- 主键：`BIGINT UNSIGNED` 自增
- 时间字段：`DATETIME(3)`；统一使用 `created_at/updated_at/deleted_at`
- 软删除：`deleted_at` 非空表示逻辑删除（业务查询默认过滤）
- 统一附件：`ap_attachment` 用 `biz_type + biz_id` 关联业务对象
- 统一消息：`ap_message` 记录“处理进度/反馈”类通知
- 约束策略：数据库结构不使用外键，依赖应用层保证引用完整性；通过索引与唯一约束保障查询与去重
- 权限配置：仅四端角色（PUBLIC/LAW/RESCUE/ADMIN），权限点可由管理员配置

## 3. 概念模型与表清单

### 3.1 账号与组织

- `ap_organization`：组织（执法部门/救助医疗机构/平台）
- `ap_user`：用户（四端角色；执法/机构/管理员绑定组织）
- `ap_role` / `ap_permission` / `ap_role_permission`：角色与权限点（用于“权限配置”）

### 3.2 事件闭环（核心链路）

- `ap_event`：事件（公众上报起点，含位置与状态）
- `ap_event_timeline`：事件时间线（上报/补充/执法/救助/反馈节点）
- `ap_attachment`：附件（事件/取证/病历/回访等统一引用）
- `ap_comment`：互动评论（事件下留言）
- `ap_message`：消息反馈（事件状态/反馈推送记录）
- `ap_task` / `ap_task_claim`：志愿者任务（巡护/救助协助）与认领记录
- `ap_patrol_report` / `ap_patrol_track_point`：巡护上报（执行结果、轨迹点）
- `ap_risk_point`：巡护风险点（与轨迹/事件形成数据支撑）

### 3.3 执法处置

- `ap_work_order`：执法工单（接收工单、是否需执法、是否转送救助）
- `ap_law_evidence`：现场取证记录（可挂附件）
- `ap_law_result`：结果录入与公示（可存公示文本与录入时间）
- `ap_case_archive`：案件归档（归档编号/归档时间/归档摘要/归档包附件）

### 3.4 救助医疗

- `ap_rescue_task`：救助任务（机构接收/评估是否救助/调度进度）
- `ap_rescue_support_report`：救助协助任务上报（志愿者提交，含定位与附件）
- `ap_animal`：动物档案（入站体检建档）
- `ap_medical_record`：治疗记录（诊疗/用药/康复信息；可挂附件）
- `ap_inventory_item` / `ap_inventory_txn`：库存管理（统计与预警）
- `ap_rescue_vehicle`：救助车辆（调度车辆管理）
- `ap_case_share` / `ap_case_share_message`：病例共享与交流

### 3.5 领养与回访（公众端）

- `ap_adoption`：领养申请
- `ap_follow_up`：回访问卷与材料（可挂附件）
- `ap_adoption_listing`：领养发布
- `ap_follow_up_task`：回访问卷任务

### 3.6 公益捐助与动保课堂（公众端）

- `ap_donation`：定向捐赠（按事件或机构）
- `ap_content_category` / `ap_content`：课堂内容（图文/视频）

### 3.7 审核与审计（管理员端）

- `ap_approval_flow`：审核流程定义（多级节点）
- `ap_approval_instance`：审核实例（绑定业务对象）
- `ap_audit_log`：审计日志（权限配置、流程维护、关键业务操作留痕）

## 4. 关键关系（摘要）

- 组织 `ap_organization` 1—N 用户 `ap_user`
- 事件 `ap_event` 1—N 时间线 `ap_event_timeline` / 评论 `ap_comment` / 附件 `ap_attachment`（通过 biz 关联）
- 事件 `ap_event` 1—N 执法工单 `ap_work_order`
- 工单 `ap_work_order` 1—N 取证 `ap_law_evidence`；1—1 结果 `ap_law_result`；0—1 归档 `ap_case_archive`
- 事件 `ap_event` 1—N 救助任务 `ap_rescue_task`
- 救助任务 `ap_rescue_task` 1—N 动物档案 `ap_animal`；动物 `ap_animal` 1—N 治疗记录 `ap_medical_record`
- 动物 `ap_animal` 0—N 领养 `ap_adoption`；领养 `ap_adoption` 1—N 回访 `ap_follow_up`
- 任务 `ap_task` 1—N 认领 `ap_task_claim`；认领 `ap_task_claim` 0—1 巡护上报 `ap_patrol_report`
- 巡护上报 `ap_patrol_report` 1—N 轨迹点 `ap_patrol_track_point`；1—N 风险点 `ap_risk_point`

## 5. 索引与查询要点（摘要）

- 事件列表：`(region_code, status, created_at)`；地理查询按业务可引入空间索引（后续扩展）
- 时间线：`(event_id, created_at)`
- 工单：`(law_org_id, status, created_at)`；救助任务：`(rescue_org_id, status, created_at)`
- 附件：`(biz_type, biz_id, created_at)`
- 捐赠：`(target_type, target_id, donated_at)`
- 巡护：轨迹点按 `report_id` 聚合；风险点按 `(risk_type, created_at)` 支撑趋势统计

## 6. 初始化 SQL

对应的建表与基础字典 SQL：`docs/数据库初始化_mysql.sql`

## 7. 表结构明细（按 SQL 字段逐一说明）

> 以下字段说明以 `docs/数据库初始化_mysql.sql` 为准，覆盖每张表的全部字段含义。

### 7.1 组织与账号

#### 7.1.1 `ap_organization`（组织：执法/救助/平台）
- `id`：主键
- `org_type`：组织类型（LAW=执法部门, RESCUE=救助医疗机构, PLATFORM=平台方）
- `name`：组织名称
- `region_code`：行政区划编码（用于数据范围）
- `address`：组织地址
- `contact_name`：联系人
- `contact_phone`：联系人电话
- `admin_user_id`：机构管理员账号ID（用于机构内员工管理与调度）
- `status`：启用状态（1启用/0禁用）
- `created_at`：创建时间
- `updated_at`：更新时间
- `deleted_at`：删除时间（软删除）

#### 7.1.2 `ap_role`（角色字典）
- `id`：主键
- `role_code`：角色编码（PUBLIC/LAW/RESCUE/ADMIN）
- `role_name`：角色名称
- `status`：启用状态
- `created_at`：创建时间
- `updated_at`：更新时间

#### 7.1.3 `ap_permission`（权限点）
- `id`：主键
- `perm_code`：权限编码
- `perm_name`：权限名称
- `perm_type`：权限类型（MENU/API/ACTION）
- `status`：启用状态
- `created_at`：创建时间
- `updated_at`：更新时间

#### 7.1.4 `ap_role_permission`（角色-权限关联）
- `id`：主键
- `role_id`：角色ID
- `perm_id`：权限ID
- `created_at`：创建时间

#### 7.1.5 `ap_user`（用户）
- `id`：主键
- `role_code`：角色编码（PUBLIC/LAW/RESCUE/ADMIN）
- `org_id`：所属组织ID（公众为空）
- `phone`：手机号/账号
- `password_hash`：密码（示例为明文，实际可替换为哈希）
- `nickname`：昵称/显示名
- `is_volunteer`：公众用户是否志愿者（1/0）
- `status`：启用状态（1启用/0禁用）
- `last_login_at`：最近登录时间
- `created_at`：创建时间
- `updated_at`：更新时间
- `deleted_at`：删除时间（软删除）

### 7.2 事件闭环

#### 7.2.1 `ap_event`（事件）
- `id`：主键
- `event_type`：事件类型（字典）
- `urgency`：紧急程度（字典）
- `description`：事件描述
- `status`：事件状态（REPORTED/TRIAGED/DISPATCHED/PROCESSING/RESOLVED/CLOSED/REJECTED/DUPLICATE等）
- `reporter_user_id`：上报人用户ID
- `reporter_anonymous`：是否匿名展示（1/0）
- `region_code`：行政区划编码
- `address`：地址
- `latitude`：纬度
- `longitude`：经度
- `reported_at`：上报时间
- `created_at`：创建时间
- `updated_at`：更新时间
- `deleted_at`：删除时间（软删除）

#### 7.2.2 `ap_event_timeline`（事件时间线）
- `id`：主键
- `event_id`：事件ID
- `node_type`：节点类型（上报/补充/派单/取证/救助/反馈/公示/归档等）
- `content`：节点内容
- `operator_role`：操作角色（PUBLIC/LAW/RESCUE/ADMIN）
- `operator_user_id`：操作人用户ID
- `created_at`：创建时间

#### 7.2.3 `ap_attachment`（统一附件）
- `id`：主键
- `biz_type`：业务类型（EVENT/LAW_EVIDENCE/MEDICAL_RECORD/FOLLOW_UP等）
- `biz_id`：业务对象ID
- `file_name`：文件名
- `file_url`：文件访问地址
- `mime_type`：MIME类型
- `file_size`：文件大小
- `sha256`：文件哈希（可选）
- `uploader_user_id`：上传人用户ID
- `created_at`：创建时间
- `deleted_at`：删除时间（软删除）

#### 7.2.4 `ap_comment`（事件评论）
- `id`：主键
- `event_id`：事件ID
- `parent_id`：父评论ID
- `author_user_id`：评论人ID
- `content`：评论内容
- `status`：状态（1正常/0隐藏）
- `created_at`：创建时间
- `deleted_at`：删除时间（软删除）

#### 7.2.5 `ap_message`（消息/反馈）
- `id`：主键
- `user_id`：接收人ID
- `msg_type`：消息类型（EVENT_UPDATE/WORK_ORDER/RESCUE_TASK/ADOPTION/DONATION等）
- `title`：标题
- `content`：内容
- `ref_type`：关联对象类型
- `ref_id`：关联对象ID
- `read_at`：阅读时间
- `created_at`：创建时间

### 7.3 志愿者任务与巡护上报

#### 7.3.1 `ap_task`（志愿者任务）
- `id`：主键
- `task_type`：任务类型（PATROL/RESCUE_SUPPORT）
- `title`：标题
- `description`：描述
- `region_code`：区域编码
- `address`：地址
- `latitude`：纬度
- `longitude`：经度
- `start_at`：开始时间
- `end_at`：结束时间
- `max_claims`：最大认领人数
- `status`：状态（OPEN/CLOSED/CANCELLED）
- `creator_role`：发布角色
- `creator_user_id`：发布人ID
- `created_at`：创建时间
- `updated_at`：更新时间
- `deleted_at`：删除时间

#### 7.3.2 `ap_task_claim`（任务认领）
- `id`：主键
- `task_id`：任务ID
- `user_id`：认领人ID
- `status`：状态（CLAIMED/STARTED/FINISHED/CANCELLED）
- `claimed_at`：认领时间
- `started_at`：开始时间
- `finished_at`：完成时间
- `cancel_reason`：取消原因
- `created_at`：创建时间
- `updated_at`：更新时间

#### 7.3.3 `ap_patrol_report`（巡护上报）
- `id`：主键
- `claim_id`：认领ID
- `summary`：巡护总结
- `distance_km`：距离（公里）
- `duration_sec`：时长（秒）
- `submitted_at`：提交时间
- `created_at`：创建时间

#### 7.3.4 `ap_patrol_track_point`（巡护轨迹点）
- `id`：主键
- `report_id`：上报ID
- `seq_no`：点序号
- `latitude`：纬度
- `longitude`：经度
- `point_time`：点时间
- `created_at`：创建时间

#### 7.3.5 `ap_risk_point`（风险点）
- `id`：主键
- `report_id`：上报ID
- `risk_type`：风险类型
- `description`：描述
- `address`：地址
- `latitude`：纬度
- `longitude`：经度
- `found_at`：标注时间
- `created_at`：创建时间

### 7.4 执法处置

#### 7.4.1 `ap_work_order`（执法工单）
- `id`：主键
- `event_id`：事件ID
- `law_org_id`：执法机构ID
- `status`：状态（NEW/ACCEPTED/ASSIGNED/ON_SITE/FINISHED/ARCHIVED/REJECTED/TRANSFERRED）
- `need_law_enforcement`：是否需执法（1/0）
- `transfer_to_rescue`：是否转送救助（1/0）
- `assignee_user_id`：执法人员ID
- `accepted_at`：受理时间
- `finished_at`：完成时间
- `created_at`：创建时间
- `updated_at`：更新时间
- `deleted_at`：删除时间

#### 7.4.2 `ap_law_evidence`（执法取证）
- `id`：主键
- `work_order_id`：工单ID
- `note`：取证说明
- `address`：现场地址
- `latitude`：纬度
- `longitude`：经度
- `collected_at`：取证时间
- `collector_user_id`：取证人ID
- `created_at`：创建时间

#### 7.4.3 `ap_law_result`（执法结果）
- `id`：主键
- `work_order_id`：工单ID
- `result_text`：内部结果说明
- `public_text`：公示文本
- `published_at`：公示时间
- `input_user_id`：录入人ID
- `created_at`：创建时间
- `updated_at`：更新时间

#### 7.4.4 `ap_case_archive`（案件归档）
- `id`：主键
- `work_order_id`：工单ID
- `archive_no`：归档编号
- `summary`：归档摘要
- `archived_at`：归档时间
- `archiver_user_id`：归档人ID
- `created_at`：创建时间

### 7.5 救助医疗

#### 7.5.1 `ap_rescue_task`（救助任务）
- `id`：主键
- `event_id`：事件ID
- `rescue_org_id`：救助机构ID（未接收时为空，接收后写入）
- `assignee_user_id`：调度人员/经办人ID（机构内员工）
- `vehicle_id`：调度车辆ID
- `status`：状态（NEW/GRABBED/DISPATCHING/DEPARTED/ARRIVED/INTAKE/FILED/TREATING/CLOSED/REJECTED）
- `need_rescue`：是否需要救助（1/0）
- `dispatch_note`：调度说明
- `dispatch_at`：出发时间
- `arrived_at`：到达时间
- `intake_at`：入站时间
- `closed_at`：关闭时间
- `created_at`：创建时间
- `updated_at`：更新时间
- `deleted_at`：删除时间

#### 7.5.2 `ap_animal`（动物档案）
- `id`：主键
- `rescue_task_id`：救助任务ID
- `shelter_no`：入站编号
- `name`：动物名称
- `species`：物种
- `breed`：品种/花色
- `sex`：性别（M/F/U）
- `age_estimate`：年龄估计
- `health_summary`：体检/健康摘要
- `status`：状态（IN_CARE/READY_FOR_ADOPTION/ADOPTED/RELEASED/DECEASED）
- `created_at`：创建时间
- `updated_at`：更新时间
- `deleted_at`：删除时间

#### 7.5.3 `ap_medical_record`（治疗记录）
- `id`：主键
- `animal_id`：动物ID
- `record_type`：记录类型（CHECKUP/TREATMENT/MEDICATION/REHAB/OTHER）
- `record_content`：记录内容（JSON）
- `recorded_at`：记录时间
- `recorder_user_id`：记录人ID
- `created_at`：创建时间
- `updated_at`：更新时间

#### 7.5.4 `ap_rescue_support_report`（救助协助任务上报）
- `id`：主键
- `claim_id`：志愿任务认领ID
- `description`：协助内容说明
- `address`：现场地址
- `latitude`：纬度
- `longitude`：经度
- `submitted_at`：提交时间
- `created_at`：创建时间

#### 7.5.5 `ap_inventory_item`（库存品项）
- `id`：主键
- `org_id`：机构ID
- `item_name`：品名/药品名称
- `production_date`：生产日期
- `expiry_date`：有效期
- `stock_qty`：当前库存
- `low_stock_threshold`：最低库存预警阈值
- `warning_days`：有效期预警天数
- `status`：状态
- `created_at`：创建时间
- `updated_at`：更新时间
- `deleted_at`：删除时间

#### 7.5.6 `ap_inventory_txn`（库存流水）
- `id`：主键
- `txn_no`：出入库单号
- `org_id`：机构ID
- `item_id`：品项ID
- `txn_type`：类型（IN/OUT/ADJUST/LOSS/RETURN）
- `qty`：数量
- `note`：备注
- `operator_user_id`：操作人ID
- `created_at`：创建时间

### 7.6 领养、回访、捐赠、课堂

#### 7.6.1 `ap_adoption`（领养申请）
- `id`：主键
- `animal_id`：动物ID
- `applicant_user_id`：申请人ID
- `status`：状态（APPLIED/APPROVED/REJECTED/CANCELLED）
- `apply_form`：申请表（JSON）
- `applied_at`：申请时间
- `decided_at`：审批时间
- `decision_note`：审批备注
- `created_at`：创建时间
- `updated_at`：更新时间
- `deleted_at`：删除时间

#### 7.6.2 `ap_follow_up`（回访）
- `id`：主键
- `adoption_id`：领养ID
- `due_at`：回访到期时间
- `questionnaire`：回访问卷（JSON）
- `submitted_at`：提交时间
- `created_at`：创建时间

#### 7.6.3 `ap_donation`（捐赠）
- `id`：主键
- `donor_user_id`：捐赠人ID
- `anonymous`：是否匿名
- `target_type`：目标类型（EVENT/ORG）
- `target_id`：目标ID
- `amount`：金额
- `status`：状态（PENDING/SUCCEEDED/FAILED/OFFLINE_RECORDED）
- `donated_at`：捐赠时间
- `created_at`：创建时间

#### 7.6.4 `ap_content_category`（课堂分类）
- `id`：主键
- `name`：分类名称
- `sort_no`：排序号
- `status`：状态
- `created_at`：创建时间
- `updated_at`：更新时间

#### 7.6.5 `ap_content`（课堂内容）
- `id`：主键
- `content_type`：内容类型（ARTICLE/VIDEO）
- `category_id`：分类ID
- `title`：标题
- `body`：图文内容
- `video_url`：视频地址
- `cover_url`：封面
- `status`：状态（DRAFT/PUBLISHED/OFFLINE）
- `published_at`：发布时间
- `created_at`：创建时间
- `updated_at`：更新时间

### 7.7 审核与审计

#### 7.7.1 `ap_approval_flow`（审核流程定义）
- `id`：主键
- `flow_code`：流程编码
- `flow_name`：流程名称
- `biz_type`：业务类型
- `steps`：节点定义（JSON）
- `status`：状态
- `created_at`：创建时间
- `updated_at`：更新时间

#### 7.7.2 `ap_approval_instance`（审核实例）
- `id`：主键
- `flow_id`：流程ID
- `biz_type`：业务类型
- `biz_id`：业务ID
- `status`：状态（PENDING/APPROVED/REJECTED/CANCELLED）
- `current_step`：当前节点
- `created_at`：创建时间
- `updated_at`：更新时间

#### 7.7.3 `ap_audit_log`（审计日志）
- `id`：主键
- `actor_user_id`：操作人ID
- `actor_role`：操作角色
- `action`：操作类型
- `target_type`：对象类型
- `target_id`：对象ID
- `detail`：明细（JSON）
- `created_at`：创建时间
#### 7.5.7 `ap_rescue_vehicle`（救助车辆）
- `id`：主键
- `org_id`：所属救助机构ID
- `plate_no`：车牌号
- `vehicle_type`：车型/用途
- `capacity`：载员/载货能力
- `status`：状态（1可用/0停用）
- `note`：备注
- `created_at`：创建时间
- `updated_at`：更新时间
- `deleted_at`：删除时间

#### 7.5.8 `ap_case_share`（病例共享）
- `id`：主键
- `animal_id`：动物档案ID
- `from_org_id`：发起共享的机构ID
- `to_org_id`：接收共享的机构ID
- `status`：共享状态（ACTIVE/CLOSED）
- `note`：共享说明
- `created_at`：创建时间
- `updated_at`：更新时间
- `closed_at`：结束共享时间

#### 7.5.9 `ap_case_share_message`（病例共享交流）
- `id`：主键
- `share_id`：共享记录ID
- `sender_org_id`：发送方机构ID
- `sender_user_id`：发送方用户ID
- `content`：消息内容
- `created_at`：创建时间
#### 7.6.6 `ap_adoption_listing`（领养发布）
- `id`：主键
- `animal_id`：动物档案ID
- `rescue_org_id`：救助机构ID
- `title`：发布标题
- `description`：发布说明
- `status`：状态（OPEN/ADOPTED/OFFLINE）
- `published_at`：发布时间
- `created_at`：创建时间
- `updated_at`：更新时间
- `deleted_at`：删除时间

#### 7.6.7 `ap_follow_up_task`（回访问卷任务）
- `id`：主键
- `adoption_id`：领养申请ID
- `status`：状态（PENDING/SUBMITTED）
- `questionnaire_template`：问卷模板（JSON）
- `sent_at`：发送时间
- `submitted_at`：提交时间
- `created_at`：创建时间
- `updated_at`：更新时间
